const{BigQuery:BigQuery}=require("@google-cloud/bigquery"),bodyParser=require("body-parser"),bigquery=new BigQuery,express=require("express"),cookieParser=require("cookie-parser"),{v4:uuid}=require("uuid"),app=express();async function query(keyword,port,tableId){let query;switch(keyword=handleColon(keyword),port){case 5e3:query=`SELECT * FROM \`database-bigquery.6893project.${tableId}\` WHERE name = '${keyword=handleColon(keyword)}' LIMIT 100`;break;case 5001:query=`SELECT id, name, src FROM \`database-bigquery.6893project.${tableId}\` WHERE lower(name) LIKE lower('%${keyword=handleColon(keyword)}%') LIMIT 10`;break;case 5002:query=`SELECT percentage FROM \`database-bigquery.6893project.${tableId}\` WHERE name = '${keyword=handleColon(keyword)}' LIMIT 100`;case 5003:query=`SELECT password FROM \`database-bigquery.6893project.${tableId}\` WHERE account = '${keyword}'`}const options={query:query,location:"us-east1"},[job]=await bigquery.createQueryJob(options),[rows]=await job.getQueryResults();let arr=[];return rows.forEach(row=>{arr.push(row)}),arr}async function addToTable(rows,datasetId,tableId){return await bigquery.dataset(datasetId).table(tableId).insert(rows),console.log(`Inserted ${rows.length} rows`),!0}function StatisticFix(arr){let obj=arr[0];for(let key in obj)"number"==typeof obj[key]&&(obj[key]=parseFloat(obj[key].toFixed(1)))}function handleColon(name){let i=0;for(;name.charAt(i);)"'"===name.charAt(i)&&(name=name.slice(0,i)+"\\"+name.slice(i),i++),i++;return name}app.use(bodyParser.json()),app.use((request,response,next)=>{console.log("有人请求服务器1(球员姓名)了"),next()}),app.get("/playerStatistic",async(request,response)=>{let playerName=decodeURI(request.url).split("?")[1].split("=")[1].split("+").join(" ");const playerStatistics=await query(playerName,5e3,"player_information");StatisticFix(playerStatistics),response.send(playerStatistics[0])}),app.listen(5e3,err=>{err||console.log("服务器1(球员姓名)启动成功了,请求球员卡信息地址为：http://localhost:5000/playerStatistic")}),app.use((request,response,next)=>{console.log("有人请求服务器2(球员名字)了"),next()}),app.post("/playerName",async(request,response)=>{const nameKey=request.body.name,playerNames=await query(nameKey,5001,"player_information");response.send(playerNames)}),app.listen(5001,err=>{err||console.log("服务器2(球员名字)启动成功了,请求补全球员名字地址为：http://localhost:5001/playerName")}),app.use((request,response,next)=>{console.log("有人请求 predictionStatistic 了"),next()}),app.post("/predictionStatistic",async(request,response)=>{const predictionStatistic=request.body,rows=[{id:predictionStatistic.id,name:predictionStatistic.name,pts:predictionStatistic.pts,reb:predictionStatistic.reb,ast:predictionStatistic.ast,blk:predictionStatistic.blk,stl:predictionStatistic.stl,tov:predictionStatistic.tov,new_request:1}],isInserted=addToTable(rows,"6893project","playerdata_to_alg_mvp");if(isInserted){let percentage=query(predictionStatistic.name,5002,"playerdata_to_alg_mvp");console.log(percentage)}response.send(isInserted?"1":"2")}),app.listen(5002,err=>{err||console.log("/predictionStatistic 接口启动了，地址为：http://localhost:5002/predictionStatistic")}),app.use(bodyParser.json()),app.use(cookieParser()),app.use((request,response,next)=>{console.log("有人请求 loginVerification 了"),next()}),app.post("/loginVerification",async(request,response)=>{const{accountNumber:accountNumber,passWord:passWord}=request.body;request.cookies.account&&request.cookies.password&&(request.cookies.account===accountNumber&&request.cookies.password===passWord?response.send("3"):request.cookies.account===accountNumber&&request.cookies.password!==passWord&&response.send("2"));const SQLpassword=await query(accountNumber,5003,"account_information");SQLpassword.length?SQLpassword[0].password!==passWord?response.send("2"):(response.cookie("account",accountNumber,{maxAge:6e4}),response.cookie("password",passWord,{maxAge:6e4}),response.send("3")):response.send("1")}),app.listen(5003,err=>{err||console.log("/loginVerification 接口启动了，地址为：http://localhost:5003/loginVerification")}),app.use((request,response,next)=>{console.log("有人请求 signup 了"),next()}),app.post("/signup",async(request,response)=>{const{accountNumber:accountNumber,passWord:passWord}=request.body,SQLpassword=await query(accountNumber,5003);if(SQLpassword.length)response.send("2");else{const rows=[{id:uuid(),account:accountNumber,password:passWord}],isInserted=addToTable(rows,"6893project","account_information");response.send(isInserted?"1":"3")}}),app.listen(5004,err=>{err||console.log("/signup 接口启动了，地址为：http://localhost:5004/signup")});